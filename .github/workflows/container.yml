name: Build Image using Containerfile
on:
  release:
      types: [prereleased]

env:
  REGISTRY_USER: ${{ github.actor }}
  REGISTRY_PASSWORD: ${{ github.token }}
  IMAGE_REGISTRY: ghcr.io/${{ github.repository_owner }}

jobs:
  buildcontainer:
    needs: signature
    strategy:
      fail-fast: false
      matrix:
        variant: [std, extra]
        arch:
            - v2Name: 32
              containerName: 386


    name: Build And Push image
    runs-on: ubuntu-latest
    steps:
        - uses: actions/checkout@v3

        - name: Log in to ghcr.io
          uses: redhat-actions/podman-login@v1
          with:
            username: ${{ env.REGISTRY_USER }}
            password: ${{ env.REGISTRY_PASSWORD }}
            registry: ${{ env.IMAGE_REGISTRY }}

        - name: Download Assets
          run: |
            bash ./release/container/downloadAssets.sh ${{  github.ref_name }} ${{ matrix.arch.v2Name }} ${{ matrix.arch.containerName }} ${{ matrix.variant }}

        - name: Buildah Action
          id: build-image
          uses: redhat-actions/buildah-build@v2
          with:
            image: v2ray
            tags: ${{  github.ref_name }}-${{ matrix.arch.v2Name }}-${{ matrix.variant }}
            containerfiles: |
              ./release/container/Containerfile
            build-args: |
              TARGETPLATFORM=${{ matrix.arch.containerName }}
              VARIANT=${{ matrix.variant }}
            archs: ${{ matrix.arch.containerName }}
            context: context/${{ matrix.arch.containerName }}
            extra-args: |
              --squash
              --timestamp 0

        - name: Push To ghcr.io
          uses: redhat-actions/push-to-registry@v2
          with:
            image: ${{ steps.build-image.outputs.image }}
            tags: ${{ steps.build-image.outputs.tags }}
            registry: ${{ env.IMAGE_REGISTRY }}